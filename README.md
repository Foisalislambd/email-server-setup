# Postfix SMTP Setup Script

A comprehensive shell script to set up Postfix SMTP server with anti-spam measures for sending verification codes and password reset emails.

## Overview

This script automates the complete setup of a Postfix SMTP server with:
- SASL authentication for secure email sending
- SSL/TLS certificates for encrypted connections
- DKIM signing to prevent emails from going to spam
- TLS encryption for secure transmission
- Anti-spam configuration with SPF, DKIM, and DMARC support
- Gmail SMTP integration (or any SMTP provider)

## Features

✅ **Complete Postfix Configuration**
- Installs Postfix and required packages
- Configures SMTP authentication
- Sets up secure email transmission with TLS

✅ **Anti-Spam Measures**
- DKIM signing with OpenDKIM
- SPF, DKIM, and DMARC DNS record instructions
- Email authentication to prevent spam folder delivery

✅ **Security Hardening**
- SASL authentication required
- SSL/TLS certificates configured
- TLS encryption enabled
- Strong TLS protocols (TLSv1.2+) enforced
- Proper file permissions
- Loopback-only interface binding

✅ **Easy Integration**
- Works with any programming language
- Standard mail() function support
- Command-line email testing

## Requirements

- Ubuntu/Debian Linux system
- Root access (sudo privileges)
- Valid domain name
- Email account with SMTP access
- DNS management access for your domain

## Installation

1. **Download the script:**
   ```bash
   wget https://your-server.com/setup_postfix_smtp.sh
   # or copy the script to your server
   ```

2. **Make it executable:**
   ```bash
   chmod +x setup_postfix_smtp.sh
   ```

3. **Run the script:**
   ```bash
   sudo ./setup_postfix_smtp.sh
   ```

## Configuration

The script will prompt you for:

- **Domain name** (e.g., example.com)
- **Email address** for sending emails (e.g., noreply@example.com)
- **Email password** (use App Password for Gmail with 2FA)
- **SMTP port** (default: 587)
- **Server hostname** (default: current hostname)

## DNS Configuration

After running the script, you **MUST** add these DNS records to prevent emails from going to spam:

### 1. SPF Record (TXT)
```
Name: @ (or your domain)
Value: v=spf1 include:_spf.google.com ~all
```

### 2. DKIM Record (TXT)
```
Name: mail._domainkey
Value: [Generated by script - shown after completion]
```

### 3. DMARC Record (TXT)
```
Name: _dmarc
Value: v=DMARC1; p=quarantine; rua=mailto:dmarc@yourdomain.com
```

### 4. Reverse DNS (PTR)
Contact your hosting provider to set up reverse DNS for your server IP pointing to your hostname.

## SSL/TLS Configuration

The script automatically configures SSL/TLS for secure email transmission:

### Certificate Options

1. **Let's Encrypt Certificate** (Recommended for production)
   ```bash
   # Get a Let's Encrypt certificate
   certbot certonly --standalone -d yourdomain.com
   ```
   - If you have an existing Let's Encrypt certificate, it will be used automatically
   - Free and trusted by all email clients
   - Auto-renewal available

2. **Self-Signed Certificate** (For testing)
   - Generated automatically if no Let's Encrypt certificate exists
   - Located in `/etc/postfix/ssl/`
   - Not trusted by email clients but enables encryption
   - Good for development and testing

### SSL Features
- **TLS 1.2+ only** - Disables weak protocols (SSLv2, SSLv3, TLSv1, TLSv1.1)
- **Strong ciphers** - Uses high-grade encryption ciphers
- **Session caching** - Improves performance with TLS session reuse
- **Perfect Forward Secrecy** - Ensures past communications remain secure

## Usage Examples

### Test Email Sending
```bash
# Send a test email
echo "Test message" | mail -s "Test Subject" recipient@example.com
```

### PHP Integration
```php
<?php
// Send verification code
$to = "user@example.com";
$subject = "Email Verification Code";
$message = "Your verification code is: 123456";
$headers = "From: noreply@" . gethostname();

if (mail($to, $subject, $message, $headers)) {
    echo "Email sent successfully";
} else {
    echo "Email sending failed";
}
?>
```

### Node.js Integration
```javascript
const { exec } = require('child_process');

function sendEmail(to, subject, message) {
    return new Promise((resolve, reject) => {
        const command = `echo "${message}" | mail -s "${subject}" ${to}`;
        exec(command, (error, stdout, stderr) => {
            if (error) {
                reject(error);
            } else {
                resolve(stdout);
            }
        });
    });
}

// Usage
sendEmail('user@example.com', 'Verification Code', 'Your code is: 123456')
    .then(result => console.log('Email sent:', result))
    .catch(error => console.error('Error:', error));
```

### Python Integration
```python
import subprocess

def send_email(to, subject, message):
    try:
        command = f'echo "{message}" | mail -s "{subject}" {to}'
        result = subprocess.run(command, shell=True, capture_output=True, text=True)
        return result.returncode == 0
    except Exception as e:
        print(f"Error sending email: {e}")
        return False

# Usage
if send_email('user@example.com', 'Verification Code', 'Your code is: 123456'):
    print("Email sent successfully")
else:
    print("Failed to send email")
```

## File Structure

After installation, the following files are created/modified:

```
/etc/postfix/
├── main.cf              # Main Postfix configuration
├── sasl_passwd          # SMTP authentication credentials
├── sasl_passwd.db       # Hashed authentication database
└── ssl/                 # SSL/TLS certificates
    ├── mail.crt         # Self-signed certificate (if used)
    └── mail.key         # Private key (if used)

/etc/opendkim/
├── opendkim.conf        # OpenDKIM configuration
└── keys/
    ├── mail.private     # DKIM private key
    ├── mail.txt         # DKIM public key for DNS
    └── mail.dns         # DNS record format

/etc/letsencrypt/live/   # Let's Encrypt certificates (if used)
└── yourdomain.com/
    ├── fullchain.pem    # Full certificate chain
    └── privkey.pem      # Private key

/root/
└── postfix_setup_guide.md  # Detailed documentation
```

## Troubleshooting

### Check Service Status
```bash
# Check Postfix status
systemctl status postfix

# Check OpenDKIM status
systemctl status opendkim

# Check mail logs
tail -f /var/log/mail.log
```

### Test Configuration
```bash
# Test Postfix configuration
postfix check

# Reload Postfix configuration
postfix reload

# Test DKIM signing
opendkim-testkey -d yourdomain.com -s mail -vvv
```

### Common Issues

1. **Emails going to spam:**
   - Ensure all DNS records (SPF, DKIM, DMARC) are properly configured
   - Check reverse DNS is set up correctly
   - Wait 24-48 hours for DNS propagation

2. **Authentication failed:**
   - Verify email credentials in `/etc/postfix/sasl_passwd`
   - For Gmail, use App Password instead of regular password
   - Ensure 2FA is enabled if using Gmail

3. **DKIM not working:**
   - Check OpenDKIM service is running: `systemctl status opendkim`
   - Verify DKIM key permissions: `ls -la /etc/opendkim/keys/`
   - Test DKIM configuration: `opendkim-testkey -d yourdomain.com -s mail`

4. **SSL/TLS issues:**
   - Check certificate files exist: `ls -la /etc/postfix/ssl/` or `/etc/letsencrypt/live/yourdomain.com/`
   - Verify certificate permissions: `ls -la /etc/postfix/ssl/mail.key` (should be 600)
   - Test SSL configuration: `openssl s_client -connect yourdomain.com:25 -starttls smtp`
   - Check TLS logs: `grep -i tls /var/log/mail.log`

## Security Considerations

- **Use strong passwords** for your email account
- **Enable 2FA** on your email account if available
- **Regularly rotate** email passwords
- **Monitor email logs** for suspicious activity
- **Use App Passwords** for Gmail accounts with 2FA
- **Use Let's Encrypt certificates** for production (not self-signed)
- **Keep SSL certificates updated** and monitor expiration
- **Consider dedicated email service** for production use

## Email Provider Support

This script works with any SMTP provider that supports:
- SASL authentication
- TLS encryption
- Standard SMTP ports (25, 587, 465)

### Popular Providers:
- **Gmail** (smtp.gmail.com:587)
- **Outlook/Hotmail** (smtp-mail.outlook.com:587)
- **Yahoo** (smtp.mail.yahoo.com:587)
- **Custom SMTP servers**

## Performance Optimization

For high-volume email sending:

1. **Adjust Postfix settings:**
   ```bash
   # Edit /etc/postfix/main.cf
   default_process_limit = 100
   smtp_connect_timeout = 30s
   smtp_helo_timeout = 30s
   ```

2. **Monitor queue:**
   ```bash
   # Check mail queue
   mailq
   
   # Flush queue if needed
   postfix flush
   ```

## Backup and Recovery

### Backup Configuration
```bash
# Backup Postfix configuration
tar -czf postfix_backup.tar.gz /etc/postfix/ /etc/opendkim/
```

### Restore Configuration
```bash
# Restore from backup
tar -xzf postfix_backup.tar.gz -C /
systemctl restart postfix opendkim
```

## Support

For issues and questions:

1. Check the logs: `/var/log/mail.log`
2. Review the documentation: `/root/postfix_setup_guide.md`
3. Test email functionality with simple commands
4. Verify DNS records are properly configured

## License

This script is provided as-is for educational and production use. Modify as needed for your specific requirements.

## Changelog

- **v1.0** - Initial release with basic Postfix setup
- **v1.1** - Added DKIM signing and anti-spam measures
- **v1.2** - Enhanced security and documentation
- **v1.3** - Added comprehensive DNS configuration guide

---

**Note:** This script is designed for Ubuntu/Debian systems. For other distributions, you may need to adjust package names and paths accordingly.